C   06/10/83 510142106  MEMBER NAME  DAMPER   (SEPT95.S)    FORTRAN
      SUBROUTINE DAMPER(E0,IE0,U0,CRAD,CIR,TDAMP,TUN,ANTIDP)
C
C
C=============================RADIATION DAMPING CONSTANTS==========================
C
C=====USING THICK LENS TRANSPORT MATRICES BUT THIN LENS DAMPING MATRIX
C=====ELEMENTS.
C
      IMPLICIT REAL*8(A-H,O-Z)
C
C
C
      DIMENSION VC6A(6),VC6B(6),VC6C(6),DAMP(6),TDAMP(6),TUN(6),DTUN(6)
      DIMENSION TREV6(6,6),WR(6),WI(6)
      DIMENSION TRIN6(6,6),RR6(6),RI6(6),VR6(6,6),VI6(6,6)
C      DIMENSION INTGE6(6),WW6(6,6),ZZ(6,6)
      PARAMETER( LWORK=64*6 )   ! now needed for  F02EBF: MV/09.10.2007
      DIMENSION WORK(LWORK)     ! now needed for  F02EBF: MV/09.10.2007
      DIMENSION INTGE6(6),WW6(6,6),ZZ(6,6)
      DIMENSION TM6A(6,6),TM6B(6,6)

C
C
C
      INCLUDE "cloorb.for"
      INCLUDE "cnlist.for"
      INCLUDE "clatic.for"
      INCLUDE "csol.for"
C
C
C
C
C
C
C
      ANTIDP=1.
      PI=3.1415926535897932D0
C
C
C


      CALL UNIT(6,TREV6)
      DO 20 I=1,NELEM
      ITY=ITYPE(I)
      IID=ID(ITY)
      CALL MX66(TMAT(1,1,ITY),ITY,IID,I,XX(ITY),X2(ITY),YY(ITY),TM6B)
C      WRITE(53,3711)IID
C 3711 FORMAT('0',/,' before DAMPED TRANSFER.', I4)
C      DO 3511 III=1,6
C 3511 WRITE(53,94)(TM6B(III,J),J=1,6)
      CALL MXDAMP(I,IID,ITY,TM6B,CRAD,XX(ITY),X2(ITY),YY(ITY),
     +                                                       NAME(ITY))



C      WRITE(53,371)IID
C 371  FORMAT('0',/,' DAMPED TRANSFER.', I4)
C      DO 351 III=1,6
C 351  WRITE(53,94)(TM6B(III,J),J=1,6)
      CALL JAM666(TREV6,TM6B,TREV6)
   20 CONTINUE
C
C      CALL UCOPY(TREV6,TM6A,72)     ! March 2009 for dropping the CERNLIB
      TM6A = TREV6 
      WRITE(53,37)
      DO 35 I=1,6
   35 WRITE(53,94)(TM6A(I,J),J=1,6)
   94 FORMAT(6F12.5)
C
C      IF(1.EQ.1)STOP
C
C
C     CALL EIV6(TM6A,TM6B,WR,WI,IERRO)
C     IF(IERRO.NE.0) GOTO 9999
C=====USE THE NAG ROUTINE. THIS IS MORE ROBUST THAN EIV6.
C      CALL UCOPY(TREV6,TRIN6,72)
      TRIN6 = TREV6
      IFAIL=0
C      CALL F02AGF(TRIN6,6,6,RR6,RI6,VR6,6,VI6,6,INTGE6,IFAIL)
      CALL F02EBF('V',6,TRIN6,6,RR6,RI6,VR6,6,VI6,6,WORK,LWORK,IFAIL) ! <<replmnt
      IF(IFAIL.NE.0)GO TO 9999
C=====WRITE OUT F02AGF RESULTS
C     WRITE(53,9266)
 9266 FORMAT(' ','NOW THE F02AGF RESULTS: 8x8')
      DO 2822 I=1,3
      IT=2*I-1
      DO 2833 J=1,6
      ZZ(J,IT  )=VR6(J,IT)
 2833 ZZ(J,IT+1)=VI6(J,IT)
 2822 CONTINUE
      DO 2844 I=1,6
      WR(I)=RR6(I)
 2844 WI(I)=RI6(I)
C      CALL UCOPY(ZZ,TM6B,72)
      TM6B = ZZ
C
C
C
      CALL RENORM(TM6B,6,WR,WI)
C
C
      WRITE(53,39)
      DO 38 I=1,6
C     DTUN(I)=DACOS(WR(I)/DSQRT(WR(I)**2+WI(I)**2))/(2.*PI)
      DTUN(I)=DATAN2(WI(I),WR(I))/(2.*PI)
   38 WRITE(53,99)WR(I),WI(I),(TM6B(J,I),J=1,6),DTUN(I)
   99 FORMAT(T12,F12.5,T27,F12.5,T41,'(',6F11.5,')',F15.8)
C
C
C=====EXTRACT DAMPING CONSTANTS FROM COMPLEX EIGENVALUES.
      DO 23 ISX=1,6
      VC6A(ISX)=DSQRT(WR(ISX)**2+WI(ISX)**2)
      XY7=-DLOG(VC6A(ISX))
      VC6C(ISX)=XY7
      VC6B(ISX)=XY7*2.*E0*1000./U0
   23 DAMP(ISX)=CIR/(3.D8*XY7)*1000.
      ERAT=2.*U0/E0/1000.
C
C
C
      WRITE(53,36) WR,WI,VC6A,VC6C,ERAT,VC6B,DAMP
C
C
C
      CALL SYMP6(TM6A)
      IF(VC6B(1).LT.0..OR.VC6B(3).LT.0..OR.VC6B(5).LT.0.)ANTIDP=-1.
C
C
C
C
C
C
C=====SINCE THE DAMPED & UNDAMPED EIGENVALUE LISTS NEED NOT COME IN
C=====THE SAME ORDER, REORDER THE DAMPING CONSTANTS FOR USE IN EMITNC.
      NDAMP=0
      DO 25 JJ=1,5,2
      DO 24 J =1,5,2
      DIF=DABS(TUN(JJ)-DTUN(J))
      IF(DIF.LT.0.002)TDAMP(JJ)=DAMP(J)
      IF(DIF.LT.0.002)NDAMP=NDAMP+1
C      IF(DIF.LT.0.001)TDAMP(JJ)=DAMP(J)      !Changed June 2004 for eRHIC coupling 
C      IF(DIF.LT.0.001)NDAMP=NDAMP+1          !studies
      write(*,*)JJ,J,TUN(JJ),DTUN(J),DIF,TDAMP(JJ),NDAMP
   24 CONTINUE                                ! Increased from 0.001 to 0.002, Aug. 2010 for LHeC
   25 CONTINUE
      IF(NDAMP.NE.3)GO TO 9988
C
C
C
C

C
C
C
      RETURN
C
C
   36 FORMAT(//,' EIGENVALUES WITH RADIATION DAMPING:',/,
     +    T7,'REAL',           T18,6(1X,F11.6),/,
     +    T7,'IMAG',           T18,6(1X,F11.6),/,
     +    T7,'ABS ',           T18,6(1X,F11.6),/,
     +    T3,'DAMPING CONST.', T18,6(1X,F11.6),'  2U0/E= ',F9.5/,
     +    T3,'PARTITION NO.',  T18,6(1X,F11.6),/,
     +    T3,'DAMP.TIME(MSEC)',T18,6(1X,F11.6))
C
C
   37 FORMAT('1',/,' DAMPED TOTAL TRANSF. AROUND THE 1-ST ELEMENT')
C
C
   39 FORMAT(//,' DAMPED EIGEN-TUNES AND EIGENVECTORS:',/,T12,
     +    'COS(2*PI*NU)',T27,'SIN(2*PI*NU)',T42,'EIGENVECTORS',T112,
     +    'TUNES(OSC.PART)')
C
C
 9999 WRITE(53,92)
   92 FORMAT(' ERROR IN EIGEN VALUE ROUTINE')
      STOP
C
C
 9988 WRITE(53,93)NDAMP
   93 FORMAT(' DAMPED AND UNDAMPED EIGENTUNES MISS-MATCHED SO STOP',I4)
      STOP
      END
